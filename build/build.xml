<!--
 | Copyright 2008-2011 ThoughtWorks, Inc.
 |
 | Licensed under the Apache License, Version 2.0 (the "License");
 | you may not use this file except in compliance with the License.
 | You may obtain a copy of the License at
 |
 |     http://www.apache.org/licenses/LICENSE-2.0
 |
 | Unless required by applicable law or agreed to in writing, software
 | distributed under the License is distributed on an "AS IS" BASIS,
 | WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 | See the License for the specific language governing permissions and
 | limitations under the License.
 |
 | Initial Contributors:
 |   Håkan Råberg
 |   Manish Chakravarty
 |   Pavan K S
 +-->
<project name="twist-osgi-spike" default="dist">
	<path id="ant.tasks.classpath">
		<fileset dir="lib">
			<include name="*.jar" />
		</fileset>
	</path>

	<taskdef resource="net/sf/ant4eclipse/antlib.xml" classpathref="ant.tasks.classpath" />
	<taskdef resource="net/sf/antcontrib/antlib.xml" classpathref="ant.tasks.classpath" />

	<exec executable="bash" outputproperty="revision">
		<arg value="-c" />
		<arg value="svn info | grep Revision | sed -e 's/Revision: //g'" />
	</exec>

	<property file="build.developer.properties" />
	<property file="build.properties" />

	<pathconvert property="workspace.dir">
		<path location="${basedir}/.." />
	</pathconvert>
	<property name="target.eclipse.dir" value="${workspace.dir}/target-eclipse" />

	<property name="dist.dir" value="${workspace.dir}/dist" />
	<property name="dist.archive.dir" value="${dist.dir}/archive" />
	<property name="dist.jar.name" value="${outer.project}-full-${revision}.jar" />
	<property name="dist.jar" value="${dist.dir}/${dist.jar.name}" />
	<property name="reports.dir" value="${workspace.dir}/reports" />

	<path id="bundles">
		<dirset dir="${workspace.dir}">
			<include name="${outer.project}*" />
		</dirset>
	</path>
	<pathconvert property="bundle.list" refid="bundles" pathsep=",">
		<flattenmapper />
	</pathconvert>

	<target name="init">
		<mkdir dir="${dist.dir}" />
	</target>

	<target name="clean" depends="clean-dist">
		<all-plugins target="clean-bundle" />
	</target>

	<target name="build-bundle" depends="init">
		<buildPlugin destDir="${dist.dir}" projectName="${plugin.id}" packageAsJar="true" workspace="${workspace.dir}">
			<javacLibraryCompiler />
			<targetPlatform>
				<location dir="${target.eclipse.dir}/eclipse" />
			</targetPlatform>
		</buildPlugin>
	</target>

	<target name="-build-bundle" depends="init">
		<echo message="${plugin.id}" />
		<if>
			<and>
				<isset property="plugin.windowingsystem" />
				<isset property="plugin.operatingsystem" />
			</and>
			<then>
				<exec executable="ant" failonerror="true">
					<env key="ANT_OPTS" value="-Dosgi.ws=${plugin.windowingsystem} -Dosgi.os=${plugin.operatingsystem}" />
					<arg value="-Dplugin.id=${plugin.id}" />
					<arg value="build-bundle" />
				</exec>
			</then>
			<else>
				<antcall target="build-bundle" />
			</else>
		</if>
	</target>

	<target name="build-feature" depends="init">
		<all-plugins target="-build-bundle" />
	</target>

	<target name="clean-bundle">
		<if>
			<hasNature workspace="${workspace.dir}" projectName="${plugin.id}" nature="java" />
			<then>
				<getOutputpath property="output.dir" workspace="${workspace.dir}" projectName="${plugin.id}" />
				<delete dir="${output.dir}" />
			</then>
		</if>
	</target>

	<target name="clean-dist">
		<delete dir="${dist.dir}" />
	</target>

	<target name="dist" depends="clean-dist, build-feature">
		<delete dir="${dist.archive.dir}" />
		<delete dir="${java.io.tmpdir}/${dist.jar.name}" />
		<mkdir dir="${dist.archive.dir}" />

		<unjar dest="${dist.archive.dir}">
			<fileset dir="${dist.dir}/plugins">
				<include name="${outer.project}_*.jar" />
			</fileset>
		</unjar>

		<copy todir="${dist.archive.dir}">
			<fileset dir="${target.eclipse.dir}">
				<exclude name="**/*.source_*.jar" />
				<exclude name=".*" />
			</fileset>
		</copy>
		<copy todir="${dist.archive.dir}/eclipse/plugins">
			<fileset dir="${dist.dir}/plugins">
				<include name="*.jar" />
				<exclude name="${outer.project}_*.jar" />
				<exclude name="*.test*.jar" />
			</fileset>
		</copy>

		<jar basedir="${dist.archive.dir}" destfile="${dist.jar}">
			<manifest>
				<attribute name="Main-Class" value="${main.class}" />
			</manifest>
		</jar>

		<echo message="" />
		<echo message="${dist.jar}" />
	</target>

	<target name="run">
		<property name="twist.driver.web.browser" value="mozilla" />
		<java jar="${dist.dir}/${outer.project}-full-${revision}.jar" fork="true">
			<jvmarg value="-Dtwist.driver.web.browser=${twist.driver.web.browser}" />
			<jvmarg value="-XstartOnFirstThread" />
		</java>
	</target>

	<target name="selenium-tests">
		<property name="project.id" value="com.thoughtworks.twist.driver.web.selenium.test" />

		<getEclipseClasspath property="selenium.tests.classpath" workspace="${workspace.dir}" projectName="${project.id}" targetPlatformLocation="${target.eclipse.dir}/eclipse" />
		<getSourcepath property="src.path" workspace="${workspace.dir}" projectName="${project.id}" />

		<if>
			<os family="mac" />
			<then>
				<property name="extra.jvm.arg" value="-XstartOnFirstThread" />
			</then>
			<else>
				<property name="extra.jvm.arg" value="" />
			</else>
		</if>

		<delete dir="${reports.dir}" />
		<mkdir dir="${reports.dir}" />

		<junit printsummary="yes" failureproperty="failure" fork="yes" forkmode="once">
			<classpath>
				<pathelement path="${selenium.tests.classpath}" />
				<pathelement location="${workspace.dir}/build/lib/junit.jar" />
			</classpath>

			<jvmarg value="${extra.jvm.arg}" />

			<formatter type="xml" />

			<batchtest todir="${reports.dir}">
				<fileset dir="${src.path}">
					<include name="**/corebased/*Test*.java" />
				</fileset>
			</batchtest>
		</junit>

		<junitreport todir="${reports.dir}">
			<fileset dir="${reports.dir}">
				<include name="TEST-*.xml" />
			</fileset>
			<report format="noframes" todir="${reports.dir}/html" />
		</junitreport>

		<fail if="failure" message="Tests Failed" />
	</target>

	<macrodef name="all-plugins">
		<attribute name="target" />
		<sequential>
			<buildFeature destDir="${dist.dir}" projectName="${feature.project}" workspace="${workspace.dir}" buildPluginTarget="@{target}" skipBuildFeature="true" targetPlatformLocation="${target.eclipse.dir}/eclipse" />
		</sequential>
	</macrodef>
</project>
